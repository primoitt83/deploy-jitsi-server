---
- name: Configurar interface ALSA Loopback
  lineinfile:
    dest: /etc/modprobe.d/alsa-loopback.conf
    state: "present"
    regexp: "^options snd-aloop enable=1,1,1,1,1 index=0,1,2,3,4"
    line: "options snd-aloop enable=1,1,1,1,1 index=0,1,2,3,4"
    create: yes
  when: instalar_jibri

- name: caregar módulo kernel do snd-aloop
  modprobe:
    name: snd-aloop
    state: present
  when: instalar_jibri

- name: Criar pasta de instalação e config
  file:
    path: "{{ INSTALACAO_PASTA }}"
    state: directory
    recurse: yes

- name: Copiar assets gráficos do serpro
  copy:
    src:  files/imagens
    dest: "{{ INSTALACAO_PASTA_WEB }}/"
  tags: assets_graficos
  when: instalar_web | bool

- name: Copiar compose file
  template:
    src: opt/jitsi/{{item}}
    dest: "{{ INSTALACAO_PASTA }}/{{item}}"
  with_items:
    - docker-compose.yml
  tags: compose
  register: compose_file_status

- debug:
    msg:
      - Status do arquivo compose - {{compose_file_status.changed}}

- name: Copiar arquivos do jibri
  template:
    src: opt/jitsi/jibri/{{item}}
    dest: "{{ INSTALACAO_PASTA_JIBRI }}/{{item}}"
  with_items:
    - ffmpeg-serpro
  tags: compose
  when: instalar_jibri | bool

- name: Compose file mudou. Reconstruindo o stack
  shell: |
    docker-compose stop
    docker-compose rm -f
    docker-compose up -d
  args:
    chdir: "{{ INSTALACAO_PASTA }}/"
  when: compose_file_status.changed
